<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Survey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Formester widget -->
    <script src="https://oexoamkq.formester.com/widget/standard.js" type="module"></script>

    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: #fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      }
      .wrap {
        min-height: 100%;
        display: grid;
        grid-template-rows: auto 1fr;
      }
      header {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        color: #666;
      }
      main {
        padding: 0;
      }
      formester-standard-form {
        display: block;
        width: 100%;
        height: 100vh; /* fill viewport */
      }
    </style>

    <script>
      // === Config ===
      const WEBHOOK_URL = "https://webhook.site/ff1f1600-5b58-4294-a49f-499cfb5b827a";
      const FORM_URL = "https://oexoamkq.formester.com/f/GPPnHNbGs"; // keep https

      function collectParams() {
        const params = new URLSearchParams(window.location.search);
        const payload = {
          clicked: true,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          referrer: document.referrer || null,
          url: location.href,
          // Common fields you mentioned:
          name: params.get("name") || "unknown",
          // Bonus: capture common marketing params if present
          utm_source: params.get("utm_source") || null,
          utm_medium: params.get("utm_medium") || null,
          utm_campaign: params.get("utm_campaign") || null,
          utm_term: params.get("utm_term") || null,
          utm_content: params.get("utm_content") || null,
        };
        return payload;
      }

      function sendWebhook(payload) {
        try {
          // Prefer Beacon (non-blocking, survives navigation)
          const ok = navigator.sendBeacon && navigator.sendBeacon(
            WEBHOOK_URL,
            new Blob([JSON.stringify(payload)], { type: "application/json" })
          );
          if (ok) return;
        } catch (_) { /* fall through to fetch */ }

        // Fallback to fetch
        fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          keepalive: true,
        }).catch(err => console.error("Webhook error:", err));
      }

      // Optional: track when the form's iframe finishes loading
      function trackFormLoaded() {
        const target = document.querySelector("formester-standard-form");
        if (!target) return;

        // The widget injects an <iframe>; observe until it appears/loads
        const obs = new MutationObserver(() => {
          const iframe = target.shadowRoot
            ? target.shadowRoot.querySelector("iframe")
            : target.querySelector("iframe");
          if (iframe) {
            iframe.addEventListener("load", () => {
              sendWebhook({ event: "form_iframe_loaded", timestamp: new Date().toISOString(), url: location.href });
            }, { once: true });
            obs.disconnect();
          }
        });
        obs.observe(target, { childList: true, subtree: true });
      }

      window.addEventListener("DOMContentLoaded", () => {
        // Fire page-load tracking
        sendWebhook(collectParams());
        // Start watching for the form iframe load (optional)
        trackFormLoaded();
      });
    </script>
  </head>

  <body>
    <div class="wrap">
      <header>Survey</header>
      <main>
        <formester-standard-form
          set-auto-height="true"
          height="100%"
          width="100%"
          id="GPPnHNbGs"
          url="https://oexoamkq.formester.com/f/GPPnHNbGs">
        </formester-standard-form>
      </main>
    </div>
  </body>
</html>
